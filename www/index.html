<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Francis Token Sale</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="assets/vendors/bootstrap/dist/css/bootstrap.css">
  <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/vendors/Ionicons/css/ionicons.min.css">
  <link rel="stylesheet" href="assets/vendors/toastr/css/toastr.min.css">

  <link rel="stylesheet" href="assets/css/AdminLTE.min.css">
  <link rel="stylesheet" href="assets/css/skins/skin-blue.min.css">
  
  <link rel="stylesheet" href="assets/css/loading.css">
  <link rel="stylesheet" href="assets/css/loading-btn.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->  
  
  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">

</head>

<body class="hold-transition skin-blue sidebar-mini">
  <div class="wrapper">
      <header class="main-header">
        <a href="#" class="logo">
          <!-- mini logo for sidebar mini 50x50 pixels -->
          <span class="logo-mini"><b>T</b>S</span>
          <!-- logo for regular state and mobile devices -->
          <span class="logo-lg"><b>TOKEN</b>Sale</span>
        </a>

        <nav class="navbar navbar-static-top">
          <!-- Sidebar toggle button-->
          <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
            <span class="sr-only">Toggle navigation</span>
          </a>

        </nav>

      </header>

      <aside class="main-sidebar">
        <section class="sidebar">
          <div class="user-panel">
            <div class="pull-left image">
              <img src="assets/img/avatar.png" class="img-circle" alt="User Image" id="profile-icon">
            </div>
            <div class="pull-left info">
              <p id="username">Anonymous</p>
              <a id="account-addr" data-toggle="tooltip" data-placement="bottom" title="" href="#"></a>
            </div>
          </div>
          <ul class="sidebar-menu" data-widget="tree">
            <li class="header">MAIN NAVIGATION</li>
            <li class="active treeview menu-open">
              <a href="#">
                <i class="fa fa-dashboard"></i> <span>Dashboard</span>
                <span class="pull-right-container">
                  <i class="fa fa-angle-left pull-right"></i>
                </span>
              </a>
              <ul class="treeview-menu">
                <li class="active"><a href="#"><i class="fa fa-circle-o"></i> Token Sale</a></li>
              </ul>
            </li>            
          </ul>
        </section>
      </aside>

      <div class="content-wrapper">
        <section class="content-header">

          <h1>
            Dashboard
            <small>Version 1.0</small>
          </h1>
          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">Dashboard</li>
          </ol>

        </section>

        <section class="content">
            <div class="row">
              <div class="col-md-12">
                  <div class="callout callout-success">
                      <h4>Smart Contract Address</h4>
                      <p>
                        <div class="row">
                          <div class="col-md-6">
                            Token Sale Address: <span id="token-sale-address">...</span>
                          </div>
                          <div class="col-md-6">
                            Token Address: <span id="token-address">...</span>      
                          </div>
                        </div>
                        
                        
                      </p>
                    </div>                
              </div>
            </div>

            <div class="row">
              <div class="col-lg-3 col-sm-6">
                <div class="small-box bg-aqua">
                  <div class="inner">
                    <h3 id="eth-balance">0</h3>
          
                    <p id="eth-price">ETH</p>
                  </div>
                  <div class="icon">
                    <i class="ion ion-bag"></i>
                  </div>
                  <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
                </div>
              </div>

              <div class="col-lg-3 col-xs-6">
                  <!-- small box -->
                  <div class="small-box bg-purple">
                    <div class="inner">
                      <h3 id="token-balance">0</h3>
        
                      <p id="token-symbol">...</p>
                    </div>
                    <div class="icon">
                      <i class="ion ion-stats-bars"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
                  </div>
              </div>

              <div class="col-lg-3 col-xs-6">
                <!-- small box -->
                <div class="small-box bg-yellow">
                  <div class="inner">
                    <h3 id="token-price">0</h3>
      
                    <p id="token-price-tier">Token / ETH</p>
                  </div>
                  <div class="icon">
                    <i class="ion ion-person-add"></i>
                  </div>
                  <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
                </div>
              </div>

              <div class="col-lg-3 col-xs-6">
                  <!-- small box -->
                  <div class="small-box bg-red">
                    <div class="inner">
                      <h3 id="token-total-supply">0</h3>
        
                      <p id="token-total-supply-text">...</p>
                    </div>
                    <div class="icon">
                      <i class="ion ion-pie-graph"></i>
                    </div>
                    <span class="small-box-footer" id="token-cap">...</span>
                  </div>
                </div>              

            </div>


            <div class="row">
                <!-- Left Column-->
                <div class="col-md-6">
                  
                  <div class="row">
                    <div class="col-md-12">
                        <div class="box box-success">
                            <div class="box-header with-border">
                                <h3 class="box-title">Profile Information</h3>                            
                            </div>
                            <form class="form-horizontal">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label for="input-username" class="col-sm-2 control-label">Username</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="input-profile-username" placeholder="Username">
                                        </div>
                                    </div>
                                </div>
                                <div class="box-footer">
                                    <button class="btn btn-default" id="btn-profile-cancel">Cancel</button>
                                    <button class="btn btn-info pull-right" id="btn-profile-update">Update</button>
                                </div>
                            </form>
                        </div>    
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-12">

                        <div class="box box-danger ld-over" id="box-buy-token">
                            <div class="ld ld-ring ld-spin"></div>

                            <div class="box-header with-border">
                                <h3 class="box-title">Buy Token</h3>
        
                                <div class="box-tools pull-right">                            
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                      <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="box-body form-horizontal">
                                
                                  <div class="form-group">
                                      <label for="input-username" class="col-sm-3 control-label">Token Quantity</label>
                                      <div class="col-sm-7">
                                          <input type="number" class="form-control" id="input-token-quantity" placeholder="Quantity">
                                      </div>
                                      <div class="col-sm-2">
                                          <span class="pull-right label label-success" id="label-eth-qty">0 ETH</span>
                                      </div>
                                  </div>
                        
                                  
                            </div>  
                            <div class="box-footer">
                                  <button class="btn btn-info pull-right" id="btn-buy-token">Buy</button>
                            </div>                  
                            
                            
                              
                        </div>
        
                      
                    </div>
                  </div>
                </div>

                <!-- Right Column -->
                <div class="col-md-6">
                  <div class="row">
                    <div class="col-md-12">
                        <div class="box box-info">
                            <div class="box-header with-border">
                                <h3 class="box-title">Profile Image</h3>                            
                            </div>
                            <form class="form-horizontal">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label for="input-profile-image" class="col-sm-2 control-label">Image</label>
                                        <div class="col-sm-10">
                                            <input type="file" id="input-profile-image">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-10 col-sm-offset-2">
                                            <img id="profile-image" class="profile-user-img img-responsive img-circle" src="assets/img/avatar.png" alt="User profile picture">
                                        </div>
                                    </div>
                                </div>
                                <div class="box-footer">
                                    <button class="btn btn-default" id="btn-profile-image-cancel">Cancel</button>
                                    <button class="btn btn-info pull-right" id="btn-profile-image-update">Update</button>
                                </div>
                            </form>
                        </div>
                    </div>
                  </div>
              </div>
          </div>

          <div class="row">
            <div class="col-md-6">
            </div>
          </div>

        </section>

      </div>

      <footer class="main-footer">
        <div class="pull-right hidden-xs">
          <b>Version</b> 1.0.0
        </div>
        <strong>Copyright &copy; 2018 <a href="https://github.com/onimusya/SolidityTutorial">Francis Hor</a>.</strong> All rights reserved.
      </footer>

  </div>
    
  <div class="modal modal-warning fade" id="modal-warning">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Something is wrong&hellip;</h4>
        </div>
        <div class="modal-body">
          <p id="modal-warning-msg"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" id="btn-warning-refresh">Refresh</button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->

    <!-- <script src="https://unpkg.com/ipfs/dist/index.min.js"></script> -->
    <script src="assets/vendors/jquery/dist/jquery.min.js"></script>
    <script src="assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="assets/vendors/fastclick/lib/fastclick.js"></script>
    <script src="assets/js/adminlte.js"></script>
    <script src="assets/vendors/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
    <script src="assets/vendors/jquery-slimscroll/jquery.slimscroll.min.js"></script>
    <script src="assets/vendors/chart.js/Chart.js"></script>
    <script src="assets/vendors/moment/moment.js"></script>
    <script src="assets/vendors/toastr/js/toastr.min.js"></script>
    <script src="assets/js/bundle.js"></script>
    <script src="assets/js/tokensale.js"></script>

    <script>

      
      $(document).ready(function() {

        var profileImageChange = false;
        var defaultProfileImage = 'assets/img/avatar.png';
        var tokenPrice = 0;

        toastr.options = {
          "closeButton": true,
          "debug": false,
          "newestOnTop": true,
          "progressBar": true,
          "positionClass": "toast-top-center",
          "preventDuplicates": true,
          "onclick": null,
          "showDuration": "300",
          "hideDuration": "1000",
          "timeOut": "5000",
          "extendedTimeOut": "1000",
          "showEasing": "swing",
          "hideEasing": "linear",
          "showMethod": "fadeIn",
          "hideMethod": "fadeOut"
        }        

        var updateUI = function () {

          $('#token-sale-address').html('<strong>' + TokenSale.props.tokenSaleAddress + '</strong>');
          $('#token-address').html('<strong>' + TokenSale.props.tokenAddress + '</strong>');
          $('#token-total-supply-text').html(TokenSale.props.tokenInfo.symbol + ' Total Supply');

          if (TokenSale.props.username.length > 0) {
            $('#username').html(TokenSale.props.username);
            $('#input-profile-username').val(TokenSale.props.username);
          } else {
            $('#username').html('Guest');
            $('#input-profile-username').val('');
          }

          var accountAddress = TokenSale.props.web3.eth.defaultAccount;
          if (accountAddress.length > 27) {
            accountAddress = accountAddress.substring(0, 24) + "...";
          }
          $('#account-addr').html(accountAddress);
          $('#account-addr').attr('title', "Account: " + TokenSale.props.web3.eth.defaultAccount);

          // Update Profile Image
          if (TokenSale.props.profileImageHash[2].toNumber() > 0) {
            // Retrieve from IPFS            
            var hash = Multihash.getMultihashFromContractResponse(TokenSale.props.profileImageHash);

            node.files.cat(hash, function (err, result) {
              if (err) {
                console.log('[Main] Error: (IPFS cat error) ' + err);
                $('#profile-image').attr('src', defaultProfileImage);
                $('#profile-icon').attr('src', defaultProfileImage);
                return;
              }
              console.log('[Main] IPFS cat success.');
              defaultProfileImage = result;
              $('#profile-image').attr('src', result);
              $('#profile-icon').attr('src', result);

            });

          } else {
            // Use default avatar
            $('#profile-image').attr('src', 'assets/img/avatar.png');
            $('#profile-icon').attr('src', 'assets/img/avatar.png');
          }

          // Update ETH Balance
          TokenSale.getEthBalance(TokenSale.props.web3.eth.defaultAccount, function (err, result) {
            if (err) {

            } else {
              console.log('[Main] ETH Balance: ' + result.toNumber());
              var eth = TokenSale.props.web3.fromWei(result, 'ether');              
              $('#eth-balance').html(eth.toFixed(4));

              // Update ETH Price
              TokenSale.getFiatPrice('BTC,ETH', 'USD,MYR', function (err, result) {
                if (err) {

                } else {
                  var totalUSD = result['ETH']['USD'] * eth;
                  $('#eth-price').html('ETH <strong>(USD ' + totalUSD.toFixed(4) + ')</strong>');
                }

              });

            }
          });


          // Update Token Info
          $('#token-symbol').html(TokenSale.props.tokenInfo.symbol);

          TokenSale.props.tokenContract.balanceOf(TokenSale.props.web3.eth.defaultAccount, function (err, result) {
              if (err) {
                console.log("[Main] Error: (Update UI) " + err);
              
              } else {
                console.log("[Main] Token Balance: " + result);          
                TokenSale.props.tokenInfo.balance = result;
                var tokenBalance = TokenSale.props.tokenInfo.balance / Math.pow(10, TokenSale.props.tokenInfo.decimals);
                $('#token-balance').html(tokenBalance.toFixed(4));
              }
              
          });

          TokenSale.props.tokenContract.totalSupply(function (err, result) {
              if (err) {
                console.log("[Main] Error: (Update UI) " + err);
              
              } else {
                console.log("[Main] Token Total Supply: " + result);          
                TokenSale.props.tokenInfo.totalSupply = result;
                var tokenTotalSupply = TokenSale.props.tokenInfo.totalSupply / Math.pow(10, TokenSale.props.tokenInfo.decimals);
                $('#token-total-supply').html(tokenTotalSupply.toFixed(4));
              }
              
          });
          
          TokenSale.props.tokenContract.cap(function (err, result) {
              if (err) {
                console.log("[Main] Error: (Update UI) " + err);
              
              } else {
                console.log("[Main] Token Cap: " + result);          
                TokenSale.props.tokenInfo.cap = result;
                var tokenCap = TokenSale.props.tokenInfo.cap / Math.pow(10, TokenSale.props.tokenInfo.decimals);
                $('#token-cap').html('Max Supply ' + tokenCap);
              }
              
          });

          

          // Get Current Price Tier
          TokenSale.props.tokenSaleContract.getCurrentPriceTierIndex(function (err, result) {
            if (err) {
              console.log('[Main] Error: (Get current price tier index in update ui) ' + err);
            } else {

              var index = result;
              TokenSale.props.tokenSaleContract.getPriceTier(index, function (err, result) {
                if (err) {
                  console.log('[Main] Error: (Get current price tier in update ui) ' + err);
                } else {
                  // 0 - Token Price
                  //console.log(result);
                  tokenPrice = result[0];
                  $('#token-price').html(result[0].toNumber());
                  $('#token-price-tier').html(TokenSale.props.tokenInfo.symbol + ' / ETH (Tier ' + (index.toNumber() + 1) + ')');

                }

              });
            }
          });
        }

        var accountChange = function () {
          TokenSale.retrieveTokenInfo(function (err, result) {

            if (err) {
              console.log('[Main] Error: (Fail to retrieve token info when account change.) ' + err);
            } else {
              
              toastr.success('Address: ' + TokenSale.props.web3.eth.defaultAccount, 'Account Change');
              updateUI();
            }

          });
          
        }

        // Profile Events
        $(document).on("click", "#btn-warning-refresh", function (e) {
          location.reload();
        });

        $(document).on('click', '#btn-profile-update', function (e) {
          e.preventDefault();
          var username = $('#input-profile-username').val();
          console.log('[Main] New username: ' + username);

          TokenSale.setUsername(username, function (err, result) {
            if (err) {
              toastr.error(err, 'Update Profile Error');
            } else {
              toastr.success('Success update profile information.', 'Success');
              updateUI();
            }
          });
        });

        // Change Profile Image
        $(document).on('change', '#input-profile-image', function (e) {
          e.stopPropagation();
          e.preventDefault();

          var files = e.target.files;
          if (!files.length) {
            toastr.warning('Please choose an image file.', 'Warning');
            $('#profile-image').attr('src', defaultProfileImage);
            profileImageChange = false;
            return false;
          }

          if (!files[0].type.match('image.*')) {
            toastr.warning('Only image file is allowed.', 'Warning');
            $('#input-profile-image').val('');
            $('#profile-image').attr('src', defaultProfileImage);
            profileImageChange = false;
            return false;            
          }

          console.log('[Main] Profile Image: ' + files[0].name + ' Size:' + files[0].size + ' Type:' + files[0].type);
          
          // Reading
          var f = files[0];
          var reader = new FileReader();

          reader.onload = (function(theFile) {
            return function(e) {
              // Render thumbnail.
              $('#profile-image').attr('src', e.target.result);
              $('#profile-image').attr('title', escape(theFile.name));
              profileImageChange = true;
              
            };
          })(f);          

          reader.readAsDataURL(f);

        });

        // Save new profile image
        $(document).on('click', '#btn-profile-image-update', function (e) {
          e.preventDefault();
          if (profileImageChange) {
            var data = $('#profile-image').attr('src');
            //console.log(data);

            // Upload to IPFS
            node.files.add(Buffer.from(data), function (err, result) {
                if (err) {
                  console.log('[Main] Error: (Upload profile image to IPFS) ' + err + ', ' + result);
                  toastr.error(err, 'Error');

                } else {
                  result.forEach(function (file) {
                    console.log('[Main] (Upload profile image to IPFS) Hash: ' + file.hash + ' Len: '+ file.hash.length);

                    var multihash = Multihash.getBytes32FromMultihash(file.hash);
                    
                    // Save to Smart Contract
                    TokenSale.props.tokenSaleContract.setImageEntry( multihash.digest, multihash.hashFunction, multihash.size, function (err, result) {
                      if (err) {
                        console.log('[Main] Error: (Save profile image hash to Smart Contract) ' + err + ', ' + result);
                        toastr.error(err, 'Error');
                      } else {
                        console.log('[Main] Success update profile image.');
                        toastr.success('Success update profile image.', 'Success');
                        location.reload();
                      }

                    });

                  });
                }
              });

          }
        });

        // Token quantity change
        $(document).on('change', '#input-token-quantity', function (e) {
          //e.stopPropagation();
          //e.preventDefault();
          
          var tokenQty = TokenSale.props.web3.toBigNumber($('#input-token-quantity').val());
          var ethQty = tokenQty / tokenPrice;

          //console.log('[Main] ETH Quantity: ' + ethQty.toFixed(4));
          $('#label-eth-qty').html(ethQty.toFixed(6) + ' ETH');

        });

        // Buy Token
        $(document).on('click', '#btn-buy-token', function (e) {
          e.preventDefault();

          var tokenQty = TokenSale.props.web3.toBigNumber($('#input-token-quantity').val());
          var ethQty = tokenQty / tokenPrice;
          
          console.log('[Main] Buy ' + tokenQty.toNumber() + ' token with ' + ethQty + ' ETH');

          $('#box-buy-token').addClass('running');

          TokenSale.purchaseToken(TokenSale.props.web3.eth.defaultAccount, ethQty, function (err, result) {
            if (err) {
              toastr.error(err, 'Buy Token Error');
              $('#box-buy-token').removeClass('running');
            } else {
              console.log('[Main] Buy token success, ' + result);
              $('#input-token-quantity').val(0);
              
              var hash = result;
              // Check for transaction confirmation
              var waitTimerId = window.setInterval(function () {
                TokenSale.props.web3.eth.getTransactionReceipt(hash, function (err, result) {
                  if (result) {
                    // Transaction is confirmed or rejected
                    window.clearInterval(waitTimerId);
                    console.log('[Main] Buy token transaction status...');
                    console.log(result);

                    updateUI();
                    $('#box-buy-token').removeClass('running');
                  } else {
                    console.log(err);
                  }

                });

              }, 2000);

            }
          });
        });

        // Init IPFS
        node.on('ready', function () {
          console.log('IPFS is ready!');
        
        TokenSale.init({}, function (err, result) {
          if (err) {
            console.log('[Main] Error: ' + err);
            
            if (err == 'metamask-not-found') {
              $('#modal-warning-msg').html("Please install MetaMask.");
            } else if (err == 'not-sign-in') {
              $('#modal-warning-msg').html("Please sign in MetaMask.");
              
              // Monitor MetaMask sign-in 
              TokenSale.monitorMetaMaskSignIn(function () {
                console.log('[Main] MetaMask is signed in.');
                // Dismiss warning modal
                $('#modal-warning').modal('hide');

                updateUI();
                
                TokenSale.monitorAccountChange(accountChange);
              });

            } else if (err == 'invalid-network') {
              $('#modal-warning-msg').html("Please switch to Ropsten or Private Network.");
              
            } else {
              $('#modal-warning-msg').html(err);
            }

            // Pop warning modal
            $('#modal-warning').modal({
              backdrop: 'static',
              keyboard: false
            });

          } else {

            console.log('[Main] Result: ' + result);
            console.log('[Main] Token Contract: ' + TokenSale.props.tokenAddress);
            console.log('[Main] Token Sale Contract: ' + TokenSale.props.tokenSaleAddress);

            updateUI();

            TokenSale.monitorAccountChange(accountChange);
            
          }
        });
      });

      });
    </script>
  


</body>

</html>
